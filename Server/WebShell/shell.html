<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>xterm.js</title>
    <script src="/js/kuangjia/jquery.js" type="text/javascript"></script>
    <script src="/js/allJS.js" type="text/javascript"></script>
    <link rel="stylesheet" href="/css/xterm.css">
    <script src="/js/xterm.js"></script>
</head>
<body>
<!-- 选择用户弹窗 -->
<div id="selectUser">
    <select id="devUserList">
        <option value="">请选择设备用户</option>
    </select>
    <button onclick="(function (){
        setCookie('user',$('#devUserList').val().split('+')[0]);
        setCookie('passwd',$('#devUserList').val().split('+')[1]);
        location.reload();
    })()">确认</button>
</div>

<div id="terminal"></div>
<script>
    if (getCookie("user") != ""){
        $("#selectUser").css("display","none");
    }else {
        $("#terminal").css("display","none");
    }
    $.get(
        "/php/user/selectDevUser.php",{"username":getCookie("UserName"),"token":getCookie("Token")},
        function(data){
            document.getElementById("devUserList").innerHTML=data;
        }
    );
</script>
<script>
    <!--  获取参数  -->
    var url = location.search; //获取url中"?"符后的字串,?ip=192.168.157.131&c=a
    var theRequest = new Object();
    if (url.indexOf("?") != -1) {
        var str = url.substr(1);//ip=192.168.157.131&c=a
        strs = str.split("&");//ip=192.168.157.131
        var ip = strs[0].split("=")[1];//192.168.157.131
    }else{
        alert("HostIP is NULL!");
    }

    var window_width = $(window).width();
    var window_height = $(window).height();
    let term = new Terminal({
        cols: Math.floor(window_width/10),
        rows: Math.floor(window_height/18),
        cursorStyle: 'underline', //光标样式
        cursorBlink: true, // 光标闪烁
        convertEol: true, //启用时，光标将设置为下一行的开头
        disableStdin: false, //是否应禁用输入。
        theme: {
            foreground: 'yellow', //字体
            background: '#060101', //背景色
            cursor: 'help',//设置光标
        }
    });
    term.open(document.getElementById('terminal'));

    function runFakeTerminal() {
        if (term._initialized) {
            return;
        }

        term._initialized = true;

        term.prompt = () => {
            term.write('\r\nroot@ubuntu:~# ');
        };
        //单独一行
        term.writeln('Welcome to xterm.js');
        prompt(term);

        let cmd = [];

        term.onKey(e => {
            const printable = !e.domEvent.altKey && !e.domEvent.altGraphKey && !e.domEvent.ctrlKey && !e.domEvent.metaKey;
            cmd.push(e.key);

            if (e.domEvent.keyCode === 13) {
                //数组最后一个是回车，去掉他
                cmd.pop();
                //判断数组长度 识别空回车
                if(cmd.length > 0){
                    var c = cmd.join("");
                    // term.write("asd"+"\n");
                    //发送命令
                    $.get(
                        "/Server/WebShell/shellSend.php",{"username":getCookie("UserName"),"token":getCookie("Token"),"ip":ip,"cmd":c,"user":getCookie("user"),"pass":getCookie("passwd")},
                        function(data){
                            term.write(data);
                        }
                    );
                }else {
                    prompt(term);
                }
                c = "";
                cmd = [];

                //保持登录
                $.get(
                    "/php/memcached.php",{"user":getCookie("UserName"),"token":getCookie("Token")},
                    function (data){
                        var obj = JSON.parse(data);
                        if (obj.status == 1){
                            //重置时间
                            setCookie("UserName",obj.username,10);
                            setCookie("Token",obj.token,10);
                            //刷新所有查询数据
                            allFlush();
                            oneFlush();
                        }
                    }
                );
            } else if (e.domEvent.keyCode === 8) {
                // Do not delete the prompt
                if (term._core.buffer.x > 2) {
                    term.write('\b \b');
                }
            } else if (printable) {
                term.write(e.key);
            }
            c = "";
        });
    }

    function prompt(term) {
        term.write('\r\nroot@ubuntu:~# ');
    }
    runFakeTerminal();
</script>
</body>
</html>